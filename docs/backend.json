
{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "name": {
          "type": "string",
          "description": "The user's display name."
        },
        "fcmToken": {
          "type": "string",
          "description": "The Firebase Cloud Messaging token for push notifications."
        }
      },
      "required": [
        "id",
        "email"
      ]
    },
    "Device": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Device",
      "type": "object",
      "description": "Represents a device owned by a user, including its settings and connection information.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the device document."
        },
        "userId": {
          "type": "string",
          "description": "The ID of the user who owns this device."
        },
        "metadata": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string",
              "description": "A descriptive name for the device (e.g., 'My Blue Device')."
            },
            "deviceId": {
              "type": "string",
              "description": "The unique hardware identifier for the device."
            },
            "ipAddress": {
              "type": "string",
              "description": "The local IP address of the ESP32 device."
            },
            "model": {
              "type": "string",
              "description": "The model of the device."
            },
            "createdAt": {
              "type": "string",
              "format": "date-time",
              "description": "The timestamp when the device was registered."
            }
          },
          "required": ["name", "deviceId"]
        },
        "currentWeather": {
          "type": "object",
          "properties": {
            "condition": {
              "type": "string",
              "description": "The last recorded weather condition from the device."
            },
            "temperature": {
              "type": "number",
              "description": "The last recorded temperature from the device."
            },
            "windspeed": {
              "type": "number",
              "description": "The last recorded windspeed from the device."
            },
            "location_str": {
              "type": "string",
              "description": "The last known location of the device as a string."
            },
            "latitude": {
              "type": "number",
              "description": "The last known latitude of the device."
            },
            "longitude": {
              "type": "number",
              "description": "The last known longitude of the device."
            },
            "forecast_daily_raw": {
                "type": "string",
                "description": "Raw JSON string for the daily forecast."
            },
            "updatedAt": {
              "type": "string",
              "format": "date-time",
              "description": "The timestamp of the last weather update."
            }
          }
        },
        "ledEnabled": {
          "type": "boolean",
          "description": "Indicates whether the LED on the device is enabled."
        },
        "leftBehindNotificationEnabled": {
          "type": "boolean",
          "description": "Indicates whether left-behind notifications are enabled for this device."
        }
      },
      "required": [
        "id",
        "userId",
        "metadata"
      ]
    },
    "NotificationLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "NotificationLog",
      "type": "object",
      "description": "Represents a log entry for a notification sent to the user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the notification log entry."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N NotificationLog). The ID of the user who received the notification."
        },
        "deviceId": {
          "type": "string",
          "description": "Reference to Device. (Relationship: Device 1:N NotificationLog). The ID of the device associated with the notification (if applicable)."
        },
        "type": {
          "type": "string",
          "description": "The type of notification (e.g., 'left_behind', 'weather_alert')."
        },
        "message": {
          "type": "string",
          "description": "The content of the notification."
        },
        "timestamp": {
          "type": "string",
          "description": "The date and time the notification was sent.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "type",
        "message",
        "timestamp"
      ]
    },
    "WeatherAlertPreference": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "WeatherAlertPreference",
      "type": "object",
      "description": "Represents a user's preferences for weather alerts.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the weather alert preference."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N WeatherAlertPreference). The ID of the user who owns these preferences."
        },
        "city": {
          "type": "string",
          "description": "The city for which to receive weather alerts."
        },
        "rainAlertEnabled": {
          "type": "boolean",
          "description": "Indicates whether rain alerts are enabled."
        },
        "temperatureAlertEnabled": {
          "type": "boolean",
          "description": "Indicates whether temperature alerts are enabled."
        },
        "temperatureThreshold": {
          "type": "number",
          "description": "The temperature threshold (in Celsius) for triggering a temperature alert."
        }
      },
      "required": [
        "id",
        "userId",
        "city",
        "rainAlertEnabled",
        "temperatureAlertEnabled",
        "temperatureThreshold"
      ]
    },
    "Notification": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Notification",
      "type": "object",
      "description": "Represents the data sent to the alert API endpoint.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "The ID of the user to send the notification to."
        },
        "deviceId": {
          "type": "string",
          "description": "The ID of the device the notification is for."
        },
        "message": {
          "type": "string",
          "description": "The content of the notification message."
        },
        "type": {
          "type": "string",
          "description": "The type of notification.",
          "enum": [
            "left_behind",
            "weather_alert",
            "custom"
          ]
        }
      },
      "required": [
        "userId",
        "deviceId",
        "message"
      ]
    },
    "UmbrellaActivity": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UmbrellaActivity",
      "type": "object",
      "description": "Represents a log of umbrella activity.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the activity log."
        },
        "condition": {
          "type": "string"
        },
        "temperature": {
          "type": "number"
        },
        "windspeed": {
          "type": "number"
        },
        "location": {
          "type": "string"
        },
        "time": {
          "type": "string",
          "format": "time"
        }
      },
      "required": ["id", "time"]
    },
    "WeatherData": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "WeatherData",
      "type": "object",
      "description": "Represents the weather data.",
      "properties": {
        "latitude": { "type": "number" },
        "longitude": { "type": "number" },
        "location_str": { "type": "string" },
        "time": { "type": "string" },
        "updatedAt": { "type": "number" },
        "temperature": { "type": "number" },
        "windspeed": { "type": "number" },
        "condition": { "type": "string" },
        "weathercode": { "type": "number" },
        "forecast_daily_raw": { "type": "string" },
        "current": {
          "type": "object",
          "description": "This nested object is expected in the public /weather/current document, but user-specific weather data is flattened.",
          "properties": {
            "temperature": { "type": "number" },
            "windspeed": { "type": "number" },
            "condition": { "type": "string" },
            "weathercode": { "type": "number" }
          }
        }
      }
    }
  },
  "auth": {
    "providers": [
      "password",
      "google.com"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Collection to store user profiles. User documents are only accessible by the user themselves.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/devices/{deviceId}",
        "definition": {
          "entityName": "Device",
          "schema": {
            "$ref": "#/backend/entities/Device"
          },
          "description": "Collection to store devices owned by a user. Includes denormalized 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "deviceId",
              "description": "The unique identifier of the device."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/devices/{deviceId}/umbrellaActivity/{activityId}",
        "definition": {
            "entityName": "UmbrellaActivity",
            "schema": {
                "$ref": "#/backend/entities/UmbrellaActivity"
            },
            "description": "Subcollection to store activity logs for a specific device.",
            "params": [
                {
                    "name": "userId",
                    "description": "The unique identifier of the user."
                },
                {
                    "name": "deviceId",
                    "description": "The unique identifier of the device."
                },
                {
                    "name": "activityId",
                    "description": "The unique identifier of the activity log entry."
                }
            ]
        }
      },
      {
        "path": "/users/{userId}/notification_logs/{notificationLogId}",
        "definition": {
          "entityName": "NotificationLog",
          "schema": {
            "$ref": "#/backend/entities/NotificationLog"
          },
          "description": "Collection to store notification logs for a user. Includes denormalized 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "notificationLogId",
              "description": "The unique identifier of the notification log entry."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/weather_alert_preferences/{weatherAlertPreferenceId}",
        "definition": {
          "entityName": "WeatherAlertPreference",
          "schema": {
            "$ref": "#/backend/entities/WeatherAlertPreference"
          },
          "description": "Collection to store weather alert preferences for a user. Includes denormalized 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "weatherAlertPreferenceId",
              "description": "The unique identifier of the weather alert preference."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/weather/{weatherDataId}",
        "definition": {
          "entityName": "WeatherData",
          "schema": {
            "$ref": "#/backend/entities/WeatherData"
          },
          "description": "Collection to store weather data logs for a specific user.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "weatherDataId",
              "description": "The unique identifier of the weather data entry (e.g., a timestamp)."
            }
          ]
        }
      },
      {
        "path": "/weather/{doc}",
        "definition": {
          "entityName": "WeatherData",
          "schema": {
            "$ref": "#/backend/entities/WeatherData"
          },
          "description": "Publicly accessible weather data.",
          "params": [
            {
              "name": "doc",
              "description": "Document ID, e.g., 'current' or a location."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to ensure security, scalability, and ease of debugging, following the principles of Authorization Independence, Clarity of Intent, DBAC, and QAPs. User-owned data is stored under the `/users/{userId}` path, providing clear ownership and simplifying security rules. Denormalization is used to avoid `get()` calls in security rules, ensuring atomic operations and making rules easier to understand.  All collections are structurally segregated based on access needs.\n\n*   **Authorization Independence**: Achieved by storing user-specific data (Devices, NotificationLogs, WeatherAlertPreferences) directly under the `/users/{userId}` collection, thus eliminating the need for hierarchical authorization and `get()` calls in security rules.\n*   **QAPs Support**:  The structure supports secure `list` operations by ensuring that each collection maintains a homogeneous security posture.  For example, only the authenticated user can access their own `/users/{userId}/devices` collection, and global roles are managed by existence checks in dedicated collections. Path-based ownership ensures the ability to secure `list` operations.\n\nThe schema focuses on path-based ownership for private data (Devices, NotificationLogs, WeatherAlertPreferences)."
  }
}
