
/**
 * @fileoverview Firestore Security Rules for the Smart Umbrella Tracker App.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data. Each user can only
 * access their own data. This is achieved by nesting all user-specific data under
 * the `/users/{userId}` path. Publicly readable data like weather is an exception.
 *
 * Data Structure:
 * - `/users/{userId}`: Stores user profiles. Only accessible by the user themselves.
 * - `/users/{userId}/devices/{deviceId}`: Stores devices owned by a user.
 * - `/users/{userId}/devices/{deviceId}/umbrellaActivity/{activityId}`: Activity log for a specific device.
 * - `/users/{userId}/notification_logs/{notificationLogId}`: Stores notification logs for a user.
 * - `/users/{userId}/alerts/{alertId}`: Stores alerts for a user.
 * - `/users/{userId}/weather_alert_preferences/{weatherAlertPreferenceId}`: Stores weather alert preferences for a user.
 * - `/users/{userId}/weather/{weatherDataId}`: Stores weather data logs for a user.
 * - `/weather/{doc}`: Stores public weather data. Readable by any authenticated user.
 *
 * Key Security Decisions:
 * - User listing is disallowed to prevent data leaks.
 * - Data is denormalized to avoid costly `get()` calls in security rules.  For example,
 *   the `userId` is included in the Device, NotificationLog, and WeatherAlertPreference
 *   documents to allow direct ownership checks.
 * - The rules explicitly deny any operation not specifically allowed.
 * - Authorization relies exclusively on the `request.auth` object, ensuring that all
 *   operations are performed by an authenticated user.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-level access control for user profiles.
     * @path /users/{userId}
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow read, write: if isOwner(userId);

      /**
       * @description Enforces user-level access control for devices.
       * @path /users/{userId}/devices/{deviceId}
       */
      match /devices/{deviceId} {
        allow read, write: if isOwner(userId);
        
        /**
         * @description Enforces user-level access control for umbrella activity.
         * @path /users/{userId}/devices/{deviceId}/umbrellaActivity/{activityId}
         */
        match /umbrellaActivity/{activityId} {
            allow read, write: if isOwner(userId);
        }
      }

      /**
       * @description Enforces user-level access control for notification logs.
       * @path /users/{userId}/notification_logs/{notificationLogId}
       */
      match /notification_logs/{notificationLogId} {
         allow read, write: if isOwner(userId);
      }
      
      /**
       * @description Enforces user-level access control for alerts.
       * @path /users/{userId}/alerts/{alertId}
       */
      match /alerts/{alertId} {
         allow read, write: if isOwner(userId);
      }

      /**
       * @description Enforces user-level access control for weather alert preferences.
       * @path /users/{userId}/weather_alert_preferences/{weatherAlertPreferenceId}
       */
      match /weather_alert_preferences/{weatherAlertPreferenceId} {
         allow read, write: if isOwner(userId);
      }

      /**
       * @description Enforces user-level access control for user-specific weather data.
       * @path /users/{userId}/weather/{weatherDataId}
       */
      match /weather/{weatherDataId} {
         allow read, write: if isOwner(userId);
      }
    }
    
    /**
     * @description Allows any authenticated user to read weather data.
     * @path /weather/{document=**}
     */
    match /weather/{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // Protect this data from client-side writes
    }
  }
}
