/**
 * @fileoverview Firestore Security Rules for the Umbrella App.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all data. Each user can only
 * access their own data. This is achieved by nesting all user-specific data under
 * the `/users/{userId}` path. Publicly readable data like weather is an exception.
 *
 * Data Structure:
 * - `/users/{userId}`: Stores user profiles. Only accessible by the user themselves.
 * - `/users/{userId}/umbrellas/{umbrellaId}`: Stores umbrellas owned by a user.
 * - `/users/{userId}/notification_logs/{notificationLogId}`: Stores notification logs for a user.
 * - `/users/{userId}/weather_alert_preferences/{weatherAlertPreferenceId}`: Stores weather alert preferences for a user.
 * - `/weather/{doc}`: Stores public weather data. Readable by any authenticated user.
 *
 * Key Security Decisions:
 * - User listing is disallowed to prevent data leaks.
 * - Data is denormalized to avoid costly `get()` calls in security rules.  For example,
 *   the `userId` is included in the Umbrella, NotificationLog, and WeatherAlertPreference
 *   documents to allow direct ownership checks.
 * - The rules explicitly deny any operation not specifically allowed.
 * - Authorization relies exclusively on the `request.auth` object, ensuring that all
 *   operations are performed by an authenticated user.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-level access control for user profiles.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     *   - auth.uid: 'user123'
     *   - request.resource.data.id: 'user123'
     * @deny (create) User with ID 'user123' cannot create a profile for another user.
     *   - auth.uid: 'user123'
     *   - request.resource.data.id: 'user456'
     * @allow (get) User with ID 'user123' can read their own profile.
     *   - auth.uid: 'user123'
     * @deny (get) User with ID 'user123' cannot read another user's profile.
     *   - auth.uid: 'user456'
     * @allow (update) User with ID 'user123' can update their own profile.
     *   - auth.uid: 'user123'
     * @deny (update) User with ID 'user123' cannot update another user's profile.
     *   - auth.uid: 'user456'
     * @allow (delete) User with ID 'user123' can delete their own profile.
     *   - auth.uid: 'user123'
     * @deny (delete) User with ID 'user123' cannot delete another user's profile.
     *   - auth.uid: 'user456'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-level access control for umbrellas.
     * @path /users/{userId}/umbrellas/{umbrellaId}
     * @allow (create) User with ID 'user123' can create an umbrella for themselves.
     *   - auth.uid: 'user123'
     *   - request.resource.data.userId: 'user123'
     * @deny (create) User with ID 'user123' cannot create an umbrella for another user.
     *   - auth.uid: 'user123'
     *   - request.resource.data.userId: 'user456'
     * @allow (get) User with ID 'user123' can read their own umbrella.
     *   - auth.uid: 'user123'
     * @deny (get) User with ID 'user123' cannot read another user's umbrella.
     *   - auth.uid: 'user456'
     * @allow (update) User with ID 'user123' can update their own umbrella.
     *   - auth.uid: 'user123'
     * @deny (update) User with ID 'user123' cannot update another user's umbrella.
     *   - auth.uid: 'user456'
     * @allow (delete) User with ID 'user123' can delete their own umbrella.
     *   - auth.uid: 'user123'
     * @deny (delete) User with ID 'user123' cannot delete another user's umbrella.
     *   - auth.uid: 'user456'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/umbrellas/{umbrellaId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-level access control for notification logs.
     * @path /users/{userId}/notification_logs/{notificationLogId}
     * @allow (create) User with ID 'user123' can create a notification log for themselves.
     *   - auth.uid: 'user123'
     *   - request.resource.data.userId: 'user123'
     * @deny (create) User with ID 'user123' cannot create a notification log for another user.
     *   - auth.uid: 'user123'
     *   - request.resource.data.userId: 'user456'
     * @allow (get) User with ID 'user123' can read their own notification log.
     *   - auth.uid: 'user123'
     * @deny (get) User with ID 'user123' cannot read another user's notification log.
     *   - auth.uid: 'user456'
     * @allow (update) User with ID 'user123' can update their own notification log.
     *   - auth.uid: 'user123'
     * @deny (update) User with ID 'user123' cannot update another user's notification log.
     *   - auth.uid: 'user456'
     * @allow (delete) User with ID 'user123' can delete their own notification log.
     *   - auth.uid: 'user123'
     * @deny (delete) User with ID 'user123' cannot delete another user's notification log.
     *   - auth.uid: 'user456'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/notification_logs/{notificationLogId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-level access control for weather alert preferences.
     * @path /users/{userId}/weather_alert_preferences/{weatherAlertPreferenceId}
     * @allow (create) User with ID 'user123' can create weather alert preferences for themselves.
     *   - auth.uid: 'user123'
     *   - request.resource.data.userId: 'user123'
     * @deny (create) User with ID 'user123' cannot create weather alert preferences for another user.
     *   - auth.uid: 'user123'
     *   - request.resource.data.userId: 'user456'
     * @allow (get) User with ID 'user123' can read their own weather alert preferences.
     *   - auth.uid: 'user123'
     * @deny (get) User with ID 'user123' cannot read another user's weather alert preferences.
     *   - auth.uid: 'user456'
     * @allow (update) User with ID 'user123' can update their own weather alert preferences.
     *   - auth.uid: 'user123'
     * @deny (update) User with ID 'user123' cannot update another user's weather alert preferences.
     *   - auth.uid: 'user456'
     * @allow (delete) User with ID 'user123' can delete their own weather alert preferences.
     *   - auth.uid: 'user123'
     * @deny (delete) User with ID 'user123' cannot delete another user's weather alert preferences.
     *   - auth.uid: 'user456'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/weather_alert_preferences/{weatherAlertPreferenceId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
    
    /**
     * @description Allows any authenticated user to read weather data.
     * @path /weather/{document=**}
     * @allow (get) Any authenticated user can read weather documents.
     * @deny (write) No user can write to the weather collection.
     */
    match /weather/{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // Protect this data from client-side writes
    }
  }
}
